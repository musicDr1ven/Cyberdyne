{"ts":1401248573739,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var videos = [];\nvar PeerConnection = window.PeerConnection || window.webkitPeerConnection00 || window.webkitRTCPeerConnection || window.mozRTCPeerConnection || window.RTCPeerConnection;\n\nfunction getNumPerRow() {\n  var len = videos.length;\n  var biggest;\n\n  // Ensure length is even for better division.\n  if(len % 2 === 1) {\n    len++;\n  }\n\n  biggest = Math.ceil(Math.sqrt(len));\n  while(len % biggest !== 0) {\n    biggest++;\n  }\n  return biggest;\n}\n\nfunction subdivideVideos() {\n  var perRow = getNumPerRow();\n  var numInRow = 0;\n  for(var i = 0, len = videos.length; i < len; i++) {\n    var video = videos[i];\n    setWH(video, i);\n    numInRow = (numInRow + 1) % perRow;\n  }\n}\n\nfunction setWH(video, i) {\n  var perRow = getNumPerRow();\n  var perColumn = Math.ceil(videos.length / perRow);\n  var width = Math.floor((window.innerWidth) / perRow);\n  var height = Math.floor((window.innerHeight - 190) / perColumn);\n  video.width = width;\n  video.height = height;\n  video.style.position = \"absolute\";\n  video.style.left = (i % perRow) * width + \"px\";\n  video.style.top = Math.floor(i / perRow) * height + \"px\";\n}\n\nfunction cloneVideo(domId, socketId) {\n  var video = document.getElementById(domId);\n  var clone = video.cloneNode(false);\n  clone.id = \"remote\" + socketId;\n  document.getElementById('videos').appendChild(clone);\n  videos.push(clone);\n  return clone;\n}\n\nfunction removeVideo(socketId) {\n  var video = document.getElementById('remote' + socketId);\n  if(video) {\n    videos.splice(videos.indexOf(video), 1);\n    video.parentNode.removeChild(video);\n  }\n}\n\nfunction addToChat(msg, color) {\n  var messages = document.getElementById('messages');\n  msg = sanitize(msg);\n  if(color) {\n    msg = '<span style=\"color: ' + color + '; padding-left: 15px\">' + msg + '</span>';\n  } else {\n    msg = '<strong style=\"padding-left: 15px\">' + msg + '</strong>';\n  }\n  messages.innerHTML = messages.innerHTML + msg + '<br>';\n  messages.scrollTop = 10000;\n}\n\nfunction sanitize(msg) {\n  return msg.replace(/</g, '&lt;');\n}\n\nfunction initFullScreen() {\n  var button = document.getElementById(\"fullscreen\");\n  button.addEventListener('click', function(event) {\n    var elem = document.getElementById(\"videos\");\n    //show full screen\n    elem.webkitRequestFullScreen();\n  });\n}\n\nfunction initNewRoom() {\n  var button = document.getElementById(\"newRoom\");\n\n  button.addEventListener('click', function(event) {\n\n    var chars = \"0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz\";\n    var string_length = 8;\n    var randomstring = '';\n    for(var i = 0; i < string_length; i++) {\n      var rnum = Math.floor(Math.random() * chars.length);\n      randomstring += chars.substring(rnum, rnum + 1);\n    }\n\n    window.location.hash = randomstring;\n    location.reload();\n  })\n}\n\n\nvar websocketChat = {\n  send: function(message) {\n    rtc._socket.send(message);\n  },\n  recv: function(message) {\n    return message;\n  },\n  event: 'receive_chat_msg'\n};\n\nvar dataChannelChat = {\n  send: function(message) {\n    for(var connection in rtc.dataChannels) {\n      var channel = rtc.dataChannels[connection];\n      channel.send(message);\n    }\n  },\n  recv: function(channel, message) {\n    return JSON.parse(message).data;\n  },\n  event: 'data stream data'\n};\n\nfunction initChat() {\n  var chat;\n\n  if(rtc.dataChannelSupport) {\n    console.log('initializing data channel chat');\n    chat = dataChannelChat;\n  } else {\n    console.log('initializing websocket chat');\n    chat = websocketChat;\n  }\n\n  var input = document.getElementById(\"chatinput\");\n  var toggleHideShow = document.getElementById(\"hideShowMessages\");\n  var room = window.location.hash.slice(1);\n  var color = \"#\" + ((1 << 24) * Math.random() | 0).toString(16);\n\n  toggleHideShow.addEventListener('click', function() {\n    var element = document.getElementById(\"messages\");\n\n    if(element.style.display === \"block\") {\n      element.style.display = \"none\";\n    }\n    else {\n      element.style.display = \"block\";\n    }\n\n  });\n\n  input.addEventListener('keydown', function(event) {\n    var key = event.which || event.keyCode;\n    if(key === 13) {\n      chat.send(JSON.stringify({\n        \"eventName\": \"chat_msg\",\n        \"data\": {\n          \"messages\": input.value,\n          \"room\": room,\n          \"color\": color\n        }\n      }));\n      addToChat(input.value);\n      input.value = \"\";\n    }\n  }, false);\n  rtc.on(chat.event, function() {\n    var data = chat.recv.apply(this, arguments);\n    console.log(data.color);\n    addToChat(data.messages, data.color.toString(16));\n  });\n}\n\n\nfunction init() {\n  if(PeerConnection) {\n    rtc.createStream({\n      \"video\": {\"mandatory\": {}, \"optional\": []},\n      \"audio\": true\n    }, function(stream) {\n      document.getElementById('you').src = URL.createObjectURL(stream);\n      document.getElementById('you').play();\n      //videos.push(document.getElementById('you'));\n      //rtc.attachStream(stream, 'you');\n      //subdivideVideos();\n    });\n  } else {\n    alert('Your browser is not supported or you have to turn on flags. In chrome you go to chrome://flags and turn on Enable PeerConnection remember to restart chrome');\n  }\n\n\n  var room = window.location.hash.slice(1);\n\n  rtc.connect(\"ws:\" + window.location.href.substring(window.location.protocol.length).split('#')[0], room);\n\n  rtc.on('add remote stream', function(stream, socketId) {\n    console.log(\"ADDING REMOTE STREAM...\");\n    var clone = cloneVideo('you', socketId);\n    document.getElementById(clone.id).setAttribute(\"class\", \"\");\n    rtc.attachStream(stream, clone.id);\n    subdivideVideos();\n  });\n  rtc.on('disconnect stream', function(data) {\n    console.log('remove ' + data);\n    removeVideo(data);\n  });\n  initFullScreen();\n  initNewRoom();\n  initChat();\n}\n\nwindow.onresize = function(event) {\n  subdivideVideos();\n};"]],"start1":0,"start2":0,"length1":0,"length2":5787}]],"length":5787}
